#/bin/bash

SRC_DIR="/data/genericrhel6/src/dynamicua.cdn.mozilla.net"

CODE_DIR="${SRC_DIR}/dynamicua"

FILE_URL_PREFIX="https://hg.mozilla.org/mozilla-central/raw-file/tip"
FILE_URL_FILENAME="ua-update.json.in"
B2G_FILE_URL_PATH="${FILE_URL_PREFIX}/b2g/app"
FILE_URL="${B2G_FILE_URL_PATH}/${FILE_URL_FILENAME}"

FILE_REVISION_NAME="file_revision.txt"
CURRENT_REVISION_FILE="${CODE_DIR}/${FILE_REVISION_NAME}"

FILE_LATEST_REVISION=$(curl -s "${FILE_URL/raw-file/file}" | grep -A1 '<td>changeset' | awk -F '[">]' '{print $9}' | awk -F '[</a]' '{print $1}' | grep -v '^$')

B2G_APP_ID="{3c2e2abc-06d4-11e1-ac3b-374f68613e61}"

FILENAME=$B2G_APP_ID

VERSION=$(cat "${SRC_DIR}/version.txt")
VERSION_DIR=$CODE_DIR/$VERSION

function checkretval(){
    retval=$?
    if [[ $retval -gt 0 ]]; then
        echo "Error!!! Exit status of the last command was $retval"
        exit $retval
    fi
}

{


if [[ ! -d $VERSION_DIR ]]
then
    mkdir $VERSION_DIR
    checkretval
fi

if [[ ! -f $CURRENT_REVISION_FILE ]]
then
    # If we don't have a current revision, write out a placeholder to force an update later on.
    echo '__NONE__' > $CURRENT_REVISION_FILE
fi

FILE_DEPLOYED_REVISION="$(cat $CURRENT_REVISION_FILE)"

if [[ "$FILE_DEPLOYED_REVISION" == "$FILE_LATEST_REVISION" ]]
then
    exit 0
fi

# get file from Mercurial
curl -s $FILE_URL -o $VERSION_DIR/$FILENAME
checkretval

# remove JS comments from file
sed -i 's/\/\/.*$//g' $VERSION_DIR/$FILENAME
checkretval

# verify we have valid json before pushing
cat $VERSION_DIR/$FILENAME | json_verify > /dev/null
checkretval

# update the current revision on disk
echo "$FILE_LATEST_REVISION" > $CURRENT_REVISION_FILE

#deploy the code
/data/genericrhel6/deploy dynamicua.cdn.mozilla.net

}
